apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  labels:
    layer: web
  name: web-deployment
spec:
  replicas: 2
  template:
    metadata:
      labels:
        name: web
        layer: web
    spec:
      containers:
      - image: sandroboehme/sample-app:1.1.3
#      - image: sandroboehme/sample-app:1.1.0
        env:
          - name: MONGO_HOST
            value: "mongo-0.mongo,mongo-1.mongo,mongo-2.mongo"
          - name: MONGO_PORT
            value: "27017"
        name: web
        ports:
        - containerPort: 8080
          name: http-port
        readinessProbe:
          httpGet:
            path: /mynode.test
            port: http-port
          initialDelaySeconds: 50
          periodSeconds: 3
        lifecycle:
          preStop:
            exec:
              # A workaround to get 0% downtime during deploys. This should
              command: ["curl http://localhost:8080/mynode.test?ready=false -u admin:admin && sleep 15"]
